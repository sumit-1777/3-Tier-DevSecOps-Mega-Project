name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  compile:
    runs-on: Agent-1
      
    steps:
      - name: checkout code 
        uses: actions/checkout@v4
    
      - name: set up Node.js
        uses: actions/setup-node@v4
        with:
         node-version: '23'
         
      - name: frontend compilation
        run: |
            cd client
            find . -name "*.js" -exec node --check {} +
      - name: Backend compilation
        run: |
            cd api
            find . -name "*.js" -exec node --check {} +   
            
  gitleaks-scan:
   runs-on: Agent-1
   needs: compile

   steps:
     - name: checkout code
       uses: actions/checkout@v4
      
     - name: Gitleak setup
       uses: gitleaks/gitleaks-action@v2
     - name: Gitleak Scan
       run: 
        gitleaks detect --source ./client --exit-code 1
        gitleaks detect --source ./api --exit-code 1

  trivy_fs_scan:
     runs-on: Agent-1
     needs: gitleaks-scan
     steps:
     - name: Checkout code
       uses: actions/checkout@v4

     - name: Run Trivy vulnerability scanner in fs mode
       uses: aquasecurity/trivy-action@0.33.1
       with:
         scan-type: 'fs'
         scan-ref: '.'
         format: 'table'
         ignore-unfixed: true
         vuln-type: 'os,library'
         severity: 'CRITICAL,HIGH'
